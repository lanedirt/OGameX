name: PR Preview Teardown

on:
  pull_request_target:
    types: [closed]

permissions:
  contents: read
  pull-requests: write

env:
  PREVIEW_BASE_DIR: /opt/previews

jobs:
  teardown:
    name: Teardown preview environment
    runs-on: [self-hosted, ctogx-preview]

    concurrency:
      group: preview-pr-${{ github.event.pull_request.number }}
      cancel-in-progress: true

    steps:
      - name: Stop and remove preview stack
        run: |
          PR=${{ github.event.pull_request.number }}
          PREVIEW_DIR="${{ env.PREVIEW_BASE_DIR }}/pr-$PR"
          echo "Tearing down preview environment for PR #$PR..."

          # Stop containers from the preview directory if it exists
          if [ -d "$PREVIEW_DIR" ]; then
            cd "$PREVIEW_DIR"
            docker compose -p pr-$PR down -v --remove-orphans || true
          else
            # Fallback: try to stop by project name only
            docker compose -p pr-$PR down -v --remove-orphans || true
          fi

          # Remove the preview directory using Docker (handles root-owned files)
          if [ -d "$PREVIEW_DIR" ]; then
            docker run --rm -v ${{ env.PREVIEW_BASE_DIR }}:/previews alpine rm -rf /previews/pr-$PR
          fi

          echo "Cleanup complete!"

      - name: Comment on PR about teardown
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ github.event.pull_request.number }};

            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            const botComment = comments.data.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Preview deployment')
            );

            const body = [
              '## Preview deployment',
              '',
              '| Status | URL | Commit |',
              '|--------|-----|--------|',
              `| :x: Destroyed | ~~pr-${prNumber}.preview.ogamex.dev~~ | - |`,
              '',
              '---',
              '*Preview environment has been cleaned up.*'
            ].join('\n');

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            }
